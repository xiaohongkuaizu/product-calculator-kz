class ProductCalculator{constructor(){this.productPriceInput=document.getElementById('productPrice');this.downPaymentRatioSelect=document.getElementById('downPaymentRatio');this.leasePeriodSelect=document.getElementById('leasePeriod');this.calculateBtn=document.getElementById('calculateBtn');this.priceError=document.getElementById('priceError');this.priceRegex=/^\d+(\.\d{1,2})?$/;this.downPayment=document.getElementById('downPayment');this.totalRent=document.getElementById('totalRent');this.installmentList=document.getElementById('installmentList');this.overviewSection=document.querySelector('.overview-section');this.billSection=document.querySelector('.bill-section');this.adminPanel=document.getElementById('adminPanel');this.closeAdminPanelBtn=document.getElementById('closeAdminPanel');this.ratioList=document.getElementById('ratioList');this.periodList=document.getElementById('periodList');this.addRatioBtn=document.getElementById('addRatioBtn');this.addPeriodBtn=document.getElementById('addPeriodBtn');this.saveSettingsBtn=document.getElementById('saveSettingsBtn');this.rateTableContainer=document.getElementById('rateTable');this.calculateBtn.disabled=true;this.priceValidationTimeout=null;this.isComposing=false;this.loadSettings();this.sortedPeriods=Object.keys(this.interestRates).map(Number).sort((a,b)=>a-b);this.initEventListeners();this.updateDownPaymentOptions();this.updateLeasePeriodOptions();}initEventListeners(){this.calculateBtn.addEventListener('click',()=>this.calculate());this.productPriceInput.addEventListener('compositionstart',()=>{this.isComposing=true;clearTimeout(this.priceValidationTimeout);});this.productPriceInput.addEventListener('compositionend',(e)=>{this.isComposing=false;this.handlePriceInput(e);});this.productPriceInput.addEventListener('input',(e)=>{if(!this.isComposing)this.handlePriceInput(e);});this.productPriceInput.addEventListener('keypress',(e)=>{if(e.key==='Enter'&&!this.calculateBtn.disabled)this.calculate();});this.downPaymentRatioSelect.addEventListener('change',()=>{this.updateLeasePeriodOptions();this.checkInputComplete();});this.leasePeriodSelect.addEventListener('change',()=>this.checkInputComplete());this.closeAdminPanelBtn.addEventListener('click',()=>this.hideAdminPanel());this.addRatioBtn.addEventListener('click',()=>this.addRatioOption());this.addPeriodBtn.addEventListener('click',()=>this.addPeriodOption());this.saveSettingsBtn.addEventListener('click',()=>this.saveSettings());this.ratioList.addEventListener('click',(e)=>{if(e.target.classList.contains('remove-btn')){const ratio=parseFloat(e.target.dataset.ratio);const listItem=e.target.closest('.list-item');if(listItem&&this.ratioList.children.length>1)listItem.remove();else alert('至少需要保留一个首付比例选项');}});this.periodList.addEventListener('click',(e)=>{if(e.target.classList.contains('remove-btn')){const period=parseFloat(e.target.dataset.period);const listItem=e.target.closest('.list-item');if(listItem&&this.periodList.children.length>1)listItem.remove();else alert('至少需要保留一个期数选项');}});}handlePriceInput(){clearTimeout(this.priceValidationTimeout);this.priceValidationTimeout=setTimeout(()=>{const isValid=this.validatePrice();this.checkAdminTrigger();const isRatioSelected=this.downPaymentRatioSelect.value!=='';const isPeriodSelected=this.leasePeriodSelect.value!=='';this.calculateBtn.disabled=!(isValid&&isRatioSelected&&isPeriodSelected);if(!this.overviewSection.classList.contains('hidden')){this.overviewSection.classList.add('hidden');this.billSection.classList.add('hidden');this.downPayment.textContent='';this.totalRent.textContent='';this.installmentList.innerHTML='';}},80);}validatePrice(){if(this.productPriceInput.value==='今天开心888'){this.priceError.textContent='';return false;}if(this.isComposing){this.priceError.textContent='';return false;}const price=this.productPriceInput.value.trim();if(!price){this.priceError.textContent='请输入商品售价';return false;}if(!this.priceRegex.test(price)){this.priceError.textContent='请输入有效的金额';return false;}const priceValue=parseFloat(price);if(priceValue<1000){this.priceError.textContent='请输入有效的商品售价';return false;}this.priceError.textContent='';return true;}checkInputComplete(){let isPriceValid=false;if(!this.isComposing)isPriceValid=this.validatePrice()&&this.productPriceInput.value.trim()!=='';const isRatioSelected=this.downPaymentRatioSelect.value!=='';const isPeriodSelected=this.leasePeriodSelect.value!=='';this.calculateBtn.disabled=!(isPriceValid&&isRatioSelected&&isPeriodSelected);}formatCurrency(amount){return '¥'+amount.toFixed(2)+'元';}calculate(){if(!this.validatePrice())return;const productPrice=parseFloat(this.productPriceInput.value);const downPaymentRatio=parseFloat(this.downPaymentRatioSelect.value);const leasePeriod=parseInt(this.leasePeriodSelect.value);this.calculateBtn.textContent='计算中...';this.calculateBtn.classList.add('loading');try{const rate=this.interestRates[leasePeriod]?.[downPaymentRatio]||0.17;const downPaymentAmount=productPrice*downPaymentRatio;const totalAmountWithRate=productPrice*(1+rate);const remainingAmount=totalAmountWithRate-downPaymentAmount;const periodCount=leasePeriod-1;const monthlyPayment=periodCount>0?remainingAmount/periodCount:0;const formattedDownPayment=this.formatCurrency(downPaymentAmount);const formattedTotalRent=this.formatCurrency(totalAmountWithRate);this.overviewSection.classList.remove('hidden');this.billSection.classList.remove('hidden');this.downPayment.textContent=formattedDownPayment;this.totalRent.textContent=formattedTotalRent;this.generateBillDetails(monthlyPayment,leasePeriod);}catch(error){alert('计算出错，请重试');console.error('计算错误:',error);}finally{this.calculateBtn.textContent='开始计算';this.calculateBtn.classList.remove('loading');}}generateBillDetails(monthlyPayment,leasePeriod){const formattedAmount=this.formatCurrency(monthlyPayment);let billsHTML='';for(let i=2;i<=leasePeriod;i++){billsHTML+='<div class="bill-item"><span class="bill-label">第'+i+'期</span><span class="bill-value currency">'+formattedAmount+'</span></div>';}this.installmentList.innerHTML=billsHTML;}checkAdminTrigger(){if(this.productPriceInput.value==='今天开心888'){this.priceError.textContent='';this.showAdminPanel();}}showAdminPanel(){this.adminPanel.style.display='block';this.populateAdminPanel();}hideAdminPanel(){this.adminPanel.style.display='none';this.productPriceInput.value='';this.validatePrice();}populateAdminPanel(){this.ratioList.innerHTML='';const ratioFragment=document.createDocumentFragment();this.downPaymentOptions.forEach(ratio=>{const ratioItem=this.createRatioItem(ratio);ratioFragment.appendChild(ratioItem);});this.ratioList.appendChild(ratioFragment);this.periodList.innerHTML='';const periodFragment=document.createDocumentFragment();this.sortedPeriods=Object.keys(this.interestRates).map(Number).sort((a,b)=>a-b);this.sortedPeriods.forEach(period=>{const periodItem=this.createPeriodItem(period);periodFragment.appendChild(periodItem);});this.periodList.appendChild(periodFragment);this.populateRateTable();}populateRateTable(){const rateTable=document.createElement('table');rateTable.className='rate-table';const thead=document.createElement('thead');const headerRow=document.createElement('tr');const emptyTh=document.createElement('th');headerRow.appendChild(emptyTh);this.sortedPeriods.forEach(period=>{const th=document.createElement('th');th.textContent=period+'期';headerRow.appendChild(th);});thead.appendChild(headerRow);rateTable.appendChild(thead);const tbody=document.createElement('tbody');this.downPaymentOptions.forEach(ratio=>{const row=document.createElement('tr');const ratioTd=document.createElement('td');ratioTd.textContent=(ratio*100).toFixed(0)+'%';row.appendChild(ratioTd);this.sortedPeriods.forEach(period=>{const td=document.createElement('td');const input=document.createElement('input');input.type='number';input.min='0';input.max='100';input.step='0.1';input.value=this.interestRates[period]?.[ratio]?(this.interestRates[period][ratio]*100).toFixed(1):'0';input.dataset.period=period;input.dataset.ratio=ratio;td.appendChild(input);row.appendChild(td);});tbody.appendChild(row);});rateTable.appendChild(tbody);this.rateTableContainer.innerHTML='';this.rateTableContainer.appendChild(rateTable);}createRatioItem(ratio){const item=document.createElement('div');item.className='list-item';const input=document.createElement('input');input.type='number';input.value=(ratio*100).toFixed(0);input.min='1';input.max='100';input.step='5';const button=document.createElement('button');button.className='remove-btn';button.dataset.ratio=ratio;button.textContent='删除';item.appendChild(input);item.appendChild(button);return item;}createPeriodItem(period){const item=document.createElement('div');item.className='list-item';const input=document.createElement('input');input.type='number';input.className='period-input';input.value=period;input.min='1';input.max='36';input.step='1';const button=document.createElement('button');button.className='remove-btn';button.dataset.period=period;button.textContent='删除';item.appendChild(input);item.appendChild(button);return item;}addRatioOption(){const ratioItem=this.createRatioItem(0.05);this.ratioList.appendChild(ratioItem);}addPeriodOption(){const maxPeriod=Math.max(...this.sortedPeriods,0);const newPeriod=maxPeriod+3;const periodItem=this.createPeriodItem(newPeriod);this.periodList.appendChild(periodItem);}saveSettings(){const ratioInputs=this.ratioList.querySelectorAll('input');const newDownPaymentOptions=Array.from(ratioInputs).map(input=>parseFloat(input.value)/100).sort((a,b)=>a-b);const periodItems=this.periodList.querySelectorAll('.list-item');const newPeriods=Array.from(periodItems).map(item=>parseInt(item.querySelector('.period-input').value)).sort((a,b)=>a-b);const newInterestRates={};const rateInputs=this.rateTableContainer.querySelectorAll('input');rateInputs.forEach(input=>{const period=parseInt(input.dataset.period);const ratio=parseFloat(input.dataset.ratio);const rate=parseFloat(input.value)/100;if(!newInterestRates[period])newInterestRates[period]={};newInterestRates[period][ratio]=rate;});for(const ratio of newDownPaymentOptions){for(const period of newPeriods){if(!newInterestRates[period])newInterestRates[period]={};if(newInterestRates[period][ratio]===undefined)newInterestRates[period][ratio]=0.17;}}this.downPaymentOptions=newDownPaymentOptions;this.interestRates=newInterestRates;this.sortedPeriods=newPeriods;this.saveSettingsToLocalStorage();this.updateDownPaymentOptions();this.updateLeasePeriodOptions();this.hideAdminPanel();alert('设置已保存');}updateDownPaymentOptions(){this.downPaymentRatioSelect.innerHTML='';const fragment=document.createDocumentFragment();this.downPaymentOptions.forEach(ratio=>{const option=document.createElement('option');option.value=ratio;option.textContent='首付'+(ratio*100).toFixed(0)+'％';fragment.appendChild(option);});this.downPaymentRatioSelect.appendChild(fragment);const thirtyPercentValue=0.3;this.downPaymentRatioSelect.value=this.downPaymentOptions.includes(thirtyPercentValue)?thirtyPercentValue:this.downPaymentOptions[0];this.updateLeasePeriodOptions();this.checkInputComplete();}updateLeasePeriodOptions(){this.leasePeriodSelect.innerHTML='';const fragment=document.createDocumentFragment();const defaultOption=document.createElement('option');defaultOption.value='';defaultOption.textContent='请选择';defaultOption.className='placeholder-option';defaultOption.disabled=true;fragment.appendChild(defaultOption);const selectedDownPayment=parseFloat(this.downPaymentRatioSelect.value);const isHighDownPayment=selectedDownPayment>=0.35;this.sortedPeriods.forEach(period=>{if(isHighDownPayment||period<=9){const option=document.createElement('option');option.value=period;option.textContent=period+'期';if(period===6)option.selected=true;fragment.appendChild(option);}});this.leasePeriodSelect.appendChild(fragment);this.checkInputComplete();}initializeDefaultSettings(){this.downPaymentOptions=[0.25,0.3,0.35,0.4,0.5];this.interestRates={6:{0.25:0.295,0.3:0.262,0.35:0.245,0.4:0.235,0.5:0.170},9:{0.25:0.325,0.3:0.286,0.35:0.272,0.4:0.256,0.5:0.210},12:{0.35:0.330,0.4:0.300,0.5:0.268}};}loadSettings(){this.initializeDefaultSettings();try{if(typeof localStorage!=='undefined'&&this.isLocalStorageAvailable()){const savedRates=localStorage.getItem('interestRates');const savedOptions=localStorage.getItem('downPaymentOptions');if(savedOptions){try{this.downPaymentOptions=JSON.parse(savedOptions);}catch(error){console.warn('Failed to load down payment options from localStorage, using defaults.');}}if(savedRates){try{this.interestRates=JSON.parse(savedRates);}catch(error){console.warn('Failed to load interest rates from localStorage, using defaults.');}}}}catch(error){console.warn('localStorage not available, using default settings.');}this.sortedPeriods=Object.keys(this.interestRates).map(Number).sort((a,b)=>a-b);}isLocalStorageAvailable(){try{const testKey='__test__';localStorage.setItem(testKey,testKey);localStorage.removeItem(testKey);return true;}catch(e){return false;}}saveSettingsToLocalStorage(){try{if(typeof localStorage!=='undefined'&&this.isLocalStorageAvailable()){localStorage.setItem('interestRates',JSON.stringify(this.interestRates));localStorage.setItem('downPaymentOptions',JSON.stringify(this.downPaymentOptions));}}catch(error){console.warn('Failed to save settings to localStorage.');}}}function initCalculator(){window.calculator=new ProductCalculator();}if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',initCalculator);}else{initCalculator();}if(typeof WeixinJSBridge!=='undefined'){WeixinJSBridge.on('page:loaded',initCalculator);}